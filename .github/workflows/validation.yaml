name: Validate

on:
    push:
        paths:
            - 'src/*/src/Bridge/**/composer.json'
            - 'src/ai-bundle/config/options.php'
            - 'splitsh.json'
            - '.github/workflows/validation.yaml'
            - '.github/scripts/validate-bridge-naming.sh'
            - '.github/scripts/validate-bridge-splitsh.sh'
            - '.github/scripts/validate-bridge-files.sh'
    pull_request:
        paths:
            - 'src/*/src/Bridge/**/composer.json'
            - 'src/ai-bundle/config/options.php'
            - 'splitsh.json'
            - '.github/workflows/validation.yaml'
            - '.github/scripts/validate-bridge-naming.sh'
            - '.github/scripts/validate-bridge-splitsh.sh'
            - '.github/scripts/validate-bridge-files.sh'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            store: ${{ steps.filter.outputs.store }}
            tool: ${{ steps.filter.outputs.tool }}
            platform: ${{ steps.filter.outputs.platform }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Filter paths
              id: filter
              uses: dorny/paths-filter@v3
              with:
                  filters: |
                      store:
                        - 'src/store/src/Bridge/**'
                      tool:
                        - 'src/agent/src/Bridge/**'
                      platform:
                        - 'src/platform/src/Bridge/**'

    validate_stores:
        name: Store Bridges
        needs: changes
        if: needs.changes.outputs.store == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Validate store bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh store store src/ai-bundle/config/options.php

            - name: Validate store bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh store

            - name: Validate store bridges have required files
              run: .github/scripts/validate-bridge-files.sh store

    validate_tools:
        name: Tool Bridges
        needs: changes
        if: needs.changes.outputs.tool == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Validate tool bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh tool agent

            - name: Validate tool bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh tool agent

            - name: Validate tool bridges have required files
              run: .github/scripts/validate-bridge-files.sh tool agent

    validate_platforms:
        name: Platform Bridges
        needs: changes
        if: needs.changes.outputs.platform == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Validate platform bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh platform platform

            - name: Validate platform bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh platform

            - name: Validate platform bridges have required files
              run: .github/scripts/validate-bridge-files.sh platform

