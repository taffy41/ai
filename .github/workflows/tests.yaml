name: Tests

on:
    push:
        paths-ignore:
            - 'src/*/doc/**'
            - 'src/**/*.md'
    pull_request:
        paths-ignore:
            - 'src/*/doc/**'
            - 'src/**/*.md'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

env:
    REQUIRED_PHP_EXTENSIONS: 'mongodb, redis'

jobs:
    # ===========================================
    # Unit Tests
    # ===========================================
    matrix:
        name: Matrix
        runs-on: ubuntu-latest
        outputs:
            packages: ${{ steps.set-matrix.outputs.packages }}
            packages-include: ${{ steps.set-matrix.outputs.packages-include }}
            store-bridges: ${{ steps.set-matrix.outputs.store-bridges }}
            store-bridges-include: ${{ steps.set-matrix.outputs.store-bridges-include }}
            tool-bridges: ${{ steps.set-matrix.outputs.tool-bridges }}
            tool-bridges-include: ${{ steps.set-matrix.outputs.tool-bridges-include }}
            platform-bridges: ${{ steps.set-matrix.outputs.platform-bridges }}
            platform-bridges-include: ${{ steps.set-matrix.outputs.platform-bridges-include }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set matrix
              id: set-matrix
              run: |
                  # Helper function to convert "ai-bundle" to "AI Bundle"
                  to_title() {
                      echo "$1" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1' \
                          | sed 's/\bAi\b/AI/g; s/\bMcp\b/MCP/g'
                  }

                  # Packages (components and bundles)
                  PACKAGES="[]"
                  for pkg in $(find src/ -mindepth 2 -type f -name composer.json -not -path "*/vendor/*" -not -path "*/Bridge/*" | xargs -I{} dirname {} | sed 's|^src/||' | grep -Ev "examples" | sort); do
                      if [[ "$pkg" == *-bundle ]]; then
                          type="Bundle"
                      else
                          type="Component"
                      fi
                      name=$(to_title "$pkg")
                      PACKAGES=$(echo "$PACKAGES" | jq -c --arg path "$pkg" --arg type "$type" --arg name "$name" '. + [{path: $path, type: $type, name: $name}]')
                  done
                  echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

                  # Generate package includes (lowest, Symfony 7.4, Symfony 8.0)
                  PACKAGES_INCLUDE=$(echo "$PACKAGES" | jq -c '
                      . as $pkgs |
                      # lowest deps with PHP 8.2
                      ($pkgs | map(. + {"php-version": "8.2", "dependency-version": "lowest"})) +
                      # Symfony 7.4 LTS with PHP 8.2
                      ($pkgs | map(. + {"php-version": "8.2", "symfony-version": "7.4.*"})) +
                      # Symfony 8.0 with PHP 8.5
                      ($pkgs | map(. + {"php-version": "8.5", "symfony-version": "8.0.*"}))
                      | map({package: {path: .path, type: .type, name: .name}} + (. | del(.path, .type, .name)))
                  ')
                  echo "packages-include=$PACKAGES_INCLUDE" >> $GITHUB_OUTPUT

                  # Store Bridges
                  STORE_BRIDGES=$(ls -1 src/store/src/Bridge/ | sort \
                      | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({component: "store", bridge: .})')
                  echo "store-bridges=$STORE_BRIDGES" >> $GITHUB_OUTPUT

                  # Generate store bridge includes (lowest, Symfony 7.4, Symfony 8.0)
                  STORE_BRIDGES_INCLUDE=$(echo "$STORE_BRIDGES" | jq -c '
                      . as $bridges |
                      # lowest deps with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "dependency-version": "lowest"})) +
                      # Symfony 7.4 LTS with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "symfony-version": "7.4.*"})) +
                      # Symfony 8.0 with PHP 8.5
                      ($bridges | map(. + {"php-version": "8.5", "symfony-version": "8.0.*"}))
                      | map({bridge: {component: .component, bridge: .bridge}} + (. | del(.component, .bridge)))
                  ')
                  echo "store-bridges-include=$STORE_BRIDGES_INCLUDE" >> $GITHUB_OUTPUT

                  # Tool Bridges
                  TOOL_BRIDGES=$(ls -1 src/agent/src/Bridge/ | sort \
                      | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({component: "agent", bridge: .})')
                  echo "tool-bridges=$TOOL_BRIDGES" >> $GITHUB_OUTPUT

                  # Generate tool bridge includes (lowest, Symfony 7.4, Symfony 8.0)
                  TOOL_BRIDGES_INCLUDE=$(echo "$TOOL_BRIDGES" | jq -c '
                      . as $bridges |
                      # lowest deps with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "dependency-version": "lowest"})) +
                      # Symfony 7.4 LTS with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "symfony-version": "7.4.*"})) +
                      # Symfony 8.0 with PHP 8.5
                      ($bridges | map(. + {"php-version": "8.5", "symfony-version": "8.0.*"}))
                      | map({bridge: {component: .component, bridge: .bridge}} + (. | del(.component, .bridge)))
                  ')
                  echo "tool-bridges-include=$TOOL_BRIDGES_INCLUDE" >> $GITHUB_OUTPUT

                  # Platform bridges
                  PLATFORM_BRIDGES=$(ls -1 src/platform/src/Bridge/ | sort \
                      | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({bridge: .})')
                  echo "platform-bridges=$PLATFORM_BRIDGES" >> $GITHUB_OUTPUT

                  # Generate platform bridge includes (lowest, Symfony 7.4, Symfony 8.0)
                  PLATFORM_BRIDGES_INCLUDE=$(echo "$PLATFORM_BRIDGES" | jq -c '
                      . as $bridges |
                      # lowest deps with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "dependency-version": "lowest"})) +
                      # Symfony 7.4 LTS with PHP 8.2
                      ($bridges | map(. + {"php-version": "8.2", "symfony-version": "7.4.*"})) +
                      # Symfony 8.0 with PHP 8.5
                      ($bridges | map(. + {"php-version": "8.5", "symfony-version": "8.0.*"}))
                      | map({bridge: {bridge: .bridge}} + (. | del(.bridge)))
                  ')
                  echo "platform-bridges-include=$PLATFORM_BRIDGES_INCLUDE" >> $GITHUB_OUTPUT

                  # Pretty print for info
                  echo "::group::Packages"
                  echo "$PACKAGES" | jq .
                  echo "::endgroup::"
                  echo "::group::Store Bridges"
                  echo "$STORE_BRIDGES" | jq .
                  echo "::endgroup::"
                  echo "::group::Tool Bridges"
                  echo "$TOOL_BRIDGES" | jq .
                  echo "::endgroup::"
                  echo "::group::Platform Bridges"
                  echo "$PLATFORM_BRIDGES" | jq .
                  echo "::endgroup::"

    packages:
        name: Unit / ${{ matrix.package.type }} / ${{ matrix.package.name }} / PHP ${{ matrix.php-version }}${{ matrix.dependency-version == 'lowest' && ' / lowest' || '' }}${{ matrix.symfony-version && format(' / Symfony {0}', matrix.symfony-version) || '' }}
        needs: matrix
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                package: ${{ fromJson(needs.matrix.outputs.packages) }}
                php-version: ['8.2', '8.5']
                dependency-version: ['']
                symfony-version: ['']
                include: ${{ fromJson(needs.matrix.outputs.packages-include) }}

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-version || '>=7.4' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Configure environment
              run: |
                  echo COLUMNS=120 >> $GITHUB_ENV
                  [ 'lowest' = '${{ matrix.dependency-version }}' ] && echo SYMFONY_DEPRECATIONS_HELPER=weak >> $GITHUB_ENV || true

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: flex
                  extensions: ${{ env.REQUIRED_PHP_EXTENSIONS }}

            - name: Install dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: src/${{ matrix.package.path }}
                  dependency-versions: ${{ matrix.dependency-version || 'highest' }}

            - name: Run PHPUnit
              run: cd src/${{ matrix.package.path }} && vendor/bin/phpunit

    store-bridges:
        name: Unit / Store / ${{ matrix.bridge.bridge }} / PHP ${{ matrix.php-version }}${{ matrix.dependency-version == 'lowest' && ' / lowest' || '' }}${{ matrix.symfony-version && format(' / Symfony {0}', matrix.symfony-version) || '' }}
        needs: matrix
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                bridge: ${{ fromJson(needs.matrix.outputs.store-bridges) }}
                php-version: ['8.2', '8.5']
                dependency-version: ['']
                symfony-version: ['']
                include: ${{ fromJson(needs.matrix.outputs.store-bridges-include) }}

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-version || '>=7.4' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Configure environment
              run: |
                  echo COLUMNS=120 >> $GITHUB_ENV
                  [ 'lowest' = '${{ matrix.dependency-version }}' ] && echo SYMFONY_DEPRECATIONS_HELPER=weak >> $GITHUB_ENV || true

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: flex
                  extensions: ${{ env.REQUIRED_PHP_EXTENSIONS }}

            - name: Install dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: src/${{ matrix.bridge.component }}/src/Bridge/${{ matrix.bridge.bridge }}
                  dependency-versions: ${{ matrix.dependency-version || 'highest' }}

            - name: Run PHPUnit
              run: cd src/${{ matrix.bridge.component }}/src/Bridge/${{ matrix.bridge.bridge }} && vendor/bin/phpunit

    tool-bridges:
        name: Unit / Tool / ${{ matrix.bridge.bridge }} / PHP ${{ matrix.php-version }}${{ matrix.dependency-version == 'lowest' && ' / lowest' || '' }}${{ matrix.symfony-version && format(' / Symfony {0}', matrix.symfony-version) || '' }}
        needs: matrix
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                bridge: ${{ fromJson(needs.matrix.outputs.tool-bridges) }}
                php-version: ['8.2', '8.5']
                dependency-version: ['']
                symfony-version: ['']
                include: ${{ fromJson(needs.matrix.outputs.tool-bridges-include) }}

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-version || '>=7.4' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Configure environment
              run: |
                  echo COLUMNS=120 >> $GITHUB_ENV
                  [ 'lowest' = '${{ matrix.dependency-version }}' ] && echo SYMFONY_DEPRECATIONS_HELPER=weak >> $GITHUB_ENV || true

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: flex
                  extensions: ${{ env.REQUIRED_PHP_EXTENSIONS }}

            - name: Install dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: src/${{ matrix.bridge.component }}/src/Bridge/${{ matrix.bridge.bridge }}
                  dependency-versions: ${{ matrix.dependency-version || 'highest' }}

            - name: Run PHPUnit
              run: cd src/${{ matrix.bridge.component }}/src/Bridge/${{ matrix.bridge.bridge }} && vendor/bin/phpunit

    platform-bridges:
        name: Unit / Platform / ${{ matrix.bridge.bridge }} / PHP ${{ matrix.php-version }}${{ matrix.dependency-version == 'lowest' && ' / lowest' || '' }}${{ matrix.symfony-version && format(' / Symfony {0}', matrix.symfony-version) || '' }}
        needs: matrix
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                bridge: ${{ fromJson(needs.matrix.outputs.platform-bridges) }}
                php-version: ['8.2', '8.5']
                dependency-version: ['']
                symfony-version: ['']
                include: ${{ fromJson(needs.matrix.outputs.platform-bridges-include) }}

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-version || '>=7.4' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Configure environment
              run: |
                  echo COLUMNS=120 >> $GITHUB_ENV
                  [ 'lowest' = '${{ matrix.dependency-version }}' ] && echo SYMFONY_DEPRECATIONS_HELPER=weak >> $GITHUB_ENV || true

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: flex
                  extensions: ${{ env.REQUIRED_PHP_EXTENSIONS }}

            # Deptrac does not support Symfony 8.0 yet
            - name: Remove deptrac (Symfony 8.0)
              if: matrix.symfony-version == '8.0.*'
              run: composer remove --dev deptrac/deptrac --no-update

            - name: Install root dependencies
              uses: ramsey/composer-install@v3

            - name: Build packages
              run: php .github/build-packages.php

            # Remove root vendor and bridge vendor to avoid circular symlinks when installing bridge dependencies
            - name: Clean vendor folders
              run: rm -rf vendor src/platform/src/Bridge/${{ matrix.bridge.bridge }}/vendor

            - name: Install dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: src/platform/src/Bridge/${{ matrix.bridge.bridge }}
                  dependency-versions: ${{ matrix.dependency-version || 'highest' }}

            - name: Run PHPUnit
              run: cd src/platform/src/Bridge/${{ matrix.bridge.bridge }} && vendor/bin/phpunit

    # ===========================================
    # Integration Tests (run after unit tests)
    # ===========================================
    demo:
        name: Integration / Demo
        needs: [packages, store-bridges, tool-bridges, platform-bridges]
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  tools: flex
                  extensions: "${{ env.REQUIRED_PHP_EXTENSIONS }}"

            - name: Install root dependencies
              uses: ramsey/composer-install@v3

            - name: Build root packages
              run: php .github/build-packages.php

            - name: Install demo dependencies
              uses: ramsey/composer-install@v3
              with:
                  composer-options: "--no-scripts"
                  working-directory: demo

            - name: Link local packages
              working-directory: demo
              run: ../link

            - run: composer run-script auto-scripts --no-interaction
              working-directory: demo

            - run: bin/console lint:container
              working-directory: demo

            - name: Run demo tests
              working-directory: demo
              run: vendor/bin/phpunit

    examples:
        name: Integration / Examples / PHP ${{ matrix.php-version }}${{ matrix.dependency-version == 'lowest' && ' / lowest' || '' }}${{ matrix.symfony-version && format(' / Symfony {0}', matrix.symfony-version) || '' }}
        needs: demo
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php-version: ['8.2', '8.5']
                dependency-version: ['']
                symfony-version: ['']
                include:
                    # lowest deps
                    -   php-version: '8.2'
                        dependency-version: 'lowest'
                    # LTS version of Symfony
                    -   php-version: '8.2'
                        symfony-version: '7.4.*'

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-version || '>=7.4' }}

        steps:
            - uses: actions/checkout@v6

            - name: Up the examples services
              working-directory: examples
              run: docker compose up -d

            - name: Configure environment
              run: |
                  echo COLUMNS=120 >> $GITHUB_ENV
                  echo COMPOSER_UP='composer update ${{ matrix.dependency-version == 'lowest' && '--prefer-lowest --prefer-stable' || '' }} --no-progress --no-interaction --ansi' >> $GITHUB_ENV
                  echo PHPUNIT='vendor/bin/phpunit' >> $GITHUB_ENV
                  [ 'lowest' = '${{ matrix.dependency-version }}' ] && export SYMFONY_DEPRECATIONS_HELPER=weak

                  PACKAGES=$(find src/ -mindepth 2 -type f -name composer.json -not -path "*/vendor/*" -printf '%h\n' | sed 's/^src\///' | grep -Ev "examples" | sort |  tr '\n' ' ')
                  echo "Packages: $PACKAGES"
                  echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: flex
                  extensions: "${{ env.REQUIRED_PHP_EXTENSIONS }}"

            - name: Install root dependencies
              uses: ramsey/composer-install@v3

            - name: Build root packages
              run: php .github/build-packages.php

            - name: Install root dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: examples

            - name: Run commands examples
              working-directory: examples
              run: |
                php commands/stores.php
                php commands/message-stores.php
